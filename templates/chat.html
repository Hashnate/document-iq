{% extends "base.html" %} 

{% block title %}Chat - DocumentIQ{% endblock %}

{% block extra_head %}
<style>
    /* DocumentIQ Theme Variables */
    :root {
        --primary-color: #4361ee;
        --secondary-color: #3a0ca3;
        --accent-color: #7209b7;
        --light-accent: #f72585;
        --text-color: #2b2d42;
        --light-text: #8d99ae;
        --background-light: #f8f9fa;
        --card-bg: #ffffff;
        --success-color: #d8dada;
        --warning-color: #f8961e;
        --error-color: #f94144;
        --glassmorphism-bg: rgba(255, 255, 255, 0.95);
        --glassmorphism-border: rgba(67, 97, 238, 0.1);
        --sidebar-width: 280px;
    }

    /* Global Page Styling */
    body {
        background: linear-gradient(135deg, 
            rgba(67, 97, 238, 0.03) 0%, 
            rgba(58, 12, 163, 0.03) 50%, 
            rgba(255, 215, 0, 0.01) 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: var(--text-color);
        line-height: 1.6;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }

    /* DeepSeek-Style Main Container */
    .deepseek-container {
        display: flex;
        height: 100vh;
        background: transparent;
        position: relative;
        overflow: hidden;
    }

    /* Modern Sidebar */
    .modern-sidebar {
        width: var(--sidebar-width);
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(25px);
        border-right: 1px solid rgba(67, 97, 238, 0.08);
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 25px rgba(67, 97, 238, 0.06);
        position: relative;
        z-index: 100;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modern-sidebar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 20%, rgba(67, 97, 238, 0.03) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(114, 9, 183, 0.03) 0%, transparent 50%);
        pointer-events: none;
    }

    /* Sidebar Header */
    .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(67, 97, 238, 0.05);
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
        flex-shrink: 0;
        position: relative;
        z-index: 2;
    }

    .new-chat-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        padding: 0.875rem 1.25rem;
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 20px rgba(67, 97, 238, 0.25);
        position: relative;
        overflow: hidden;
        font-size: 0.95rem;
        width: 100%;
        text-decoration: none;
    }

    .new-chat-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.6s ease;
    }

    .new-chat-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(67, 97, 238, 0.35);
        color: white;
        text-decoration: none;
    }

    .new-chat-btn:hover::before {
        left: 100%;
    }

    /* Chat History */
    .chat-history {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        scrollbar-width: thin;
        scrollbar-color: rgba(67, 97, 238, 0.2) transparent;
        position: relative;
        z-index: 2;
    }

    .chat-history::-webkit-scrollbar {
        width: 4px;
    }

    .chat-history::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-history::-webkit-scrollbar-thumb {
        background: rgba(67, 97, 238, 0.2);
        border-radius: 2px;
    }

    .chat-history::-webkit-scrollbar-thumb:hover {
        background: rgba(67, 97, 238, 0.3);
    }

    /* Chat History Items */
    .chat-item-container {
        margin-bottom: 0.5rem;
        border-radius: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(67, 97, 238, 0.05);
    }

    .chat-item-container:hover {
        background: rgba(67, 97, 238, 0.06);
        transform: translateX(3px);
        box-shadow: 0 2px 15px rgba(67, 97, 238, 0.1);
        border-color: rgba(67, 97, 238, 0.1);
    }

    .chat-item-container.active {
        background: rgba(67, 97, 238, 0.1);
        border-color: var(--primary-color);
        transform: translateX(3px);
        box-shadow: 0 2px 15px rgba(67, 97, 238, 0.15);
    }

    .chat-item {
        display: flex;
        align-items: center;
        padding: 0.875rem;
        text-decoration: none;
        color: var(--text-color);
        transition: all 0.3s ease;
    }

    .chat-item-icon {
        margin-right: 0.75rem;
        color: var(--primary-color);
        font-size: 1.1rem;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .chat-item-container:hover .chat-item-icon {
        transform: scale(1.05);
        color: var(--accent-color);
    }

    .chat-item-title {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .delete-chat-btn {
        background: none;
        border: none;
        color: var(--light-text);
        cursor: pointer;
        padding: 0.375rem;
        border-radius: 6px;
        opacity: 0;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .chat-item-container:hover .delete-chat-btn {
        opacity: 1;
    }

    .delete-chat-btn:hover {
        color: var(--error-color);
        background: rgba(249, 65, 68, 0.1);
        transform: scale(1.05);
    }

    /* Main Chat Area */
    .main-chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.97);
        backdrop-filter: blur(25px);
        position: relative;
        overflow: hidden;
    }

    .main-chat-area::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--light-accent));
        z-index: 10;
    }

    /* Chat Header */
    .chat-header {
        padding: 1.25rem 2rem;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border-bottom: 1px solid rgba(67, 97, 238, 0.06);
        flex-shrink: 0;
        position: relative;
        z-index: 50;
    }

    .chat-title {
        margin: 0;
        color: var(--text-color);
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chat-title-icon {
        color: var(--primary-color);
        font-size: 1.2rem;
    }

    /* Documents Panel */
    .documents-panel {
        width: 260px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-left: 1px solid rgba(67, 97, 238, 0.08);
        overflow-y: auto;
        padding: 1rem;
        position: relative;
        z-index: 90;
        box-shadow: -2px 0 25px rgba(67, 97, 238, 0.06);
    }

    .documents-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(67, 97, 238, 0.08);
    }

    .documents-title {
        margin: 0;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-color);
        font-weight: 600;
    }

    .document-count {
        font-size: 0.8rem;
        background: rgba(67, 97, 238, 0.1);
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        color: var(--primary-color);
        font-weight: 500;
    }

    .document-list {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .document-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(67, 97, 238, 0.05);
    }

    .document-item:hover {
        background: rgba(67, 97, 238, 0.06);
        transform: translateX(2px);
        border-color: rgba(67, 97, 238, 0.1);
    }

    .document-item.active {
        background: rgba(67, 97, 238, 0.1);
        border-color: var(--primary-color);
    }

    .document-icon {
        margin-right: 0.75rem;
        color: var(--primary-color);
        font-size: 1rem;
        flex-shrink: 0;
    }

    .document-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .document-preview-btn {
        opacity: 0;
        transition: all 0.2s ease;
        color: var(--primary-color);
        padding: 0.25rem;
        border-radius: 4px;
        cursor: pointer;
    }

    .document-item:hover .document-preview-btn {
        opacity: 1;
    }

    .document-preview-btn:hover {
        background: rgba(67, 97, 238, 0.1);
    }

    /* Chat Messages */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem 2rem;
        scrollbar-width: thin;
        scrollbar-color: rgba(67, 97, 238, 0.2) transparent;
        background: transparent;
        scroll-behavior: smooth;
        min-height: 0;
        padding-bottom: 140px;
    }

    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: rgba(67, 97, 238, 0.03);
        border-radius: 3px;
        margin: 8px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(67, 97, 238, 0.2);
        border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: rgba(67, 97, 238, 0.3);
    }

    /* Enhanced Message Styling */
    .message {
        display: flex;
        gap: 1rem;
        padding: 1.25rem;
        margin-bottom: 1.25rem;
        border-radius: 16px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        animation: messageSlideIn 0.4s ease-out;
        position: relative;
        overflow: hidden;
    }

    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(15px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-user {
        background: rgba(67, 97, 238, 0.06);
        border: 1px solid rgba(67, 97, 238, 0.1);
        border-radius: 16px 16px 4px 16px;
        margin-left: 3rem;
    }

    .message-assistant {
        background: rgba(114, 9, 183, 0.04);
        border: 1px solid rgba(114, 9, 183, 0.08);
        border-radius: 16px 16px 16px 4px;
        margin-right: 3rem;
    }

    .message:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 20px rgba(67, 97, 238, 0.08);
    }

    .message:hover .message-actions {
        opacity: 1;
    }

    .message-avatar {
        flex-shrink: 0;
        width: 38px;
        height: 38px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.1rem;
        box-shadow: 0 2px 12px rgba(67, 97, 238, 0.25);
        transition: all 0.3s ease;
    }

    .message:hover .message-avatar {
        transform: scale(1.03);
        box-shadow: 0 4px 16px rgba(67, 97, 238, 0.3);
    }

    .message-content {
        flex: 1;
        min-width: 0;
        position: relative;
    }

    .message-actions {
        position: absolute;
        top: -8px;
        right: -8px;
        opacity: 0;
        transition: all 0.3s ease;
        display: flex;
        gap: 0.375rem;
        z-index: 10;
    }

    .copy-message-btn {
        background: rgba(255, 255, 255, 0.98);
        border: 1px solid rgba(67, 97, 238, 0.15);
        border-radius: 8px;
        padding: 0.375rem;
        cursor: pointer;
        color: var(--primary-color);
        font-size: 0.85rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(67, 97, 238, 0.1);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2.25rem;
        height: 2.25rem;
    }

    .copy-message-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(67, 97, 238, 0.25);
    }

    .copy-message-btn.copied {
        background: var(--success-color);
        color: white;
        animation: copySuccess 0.3s ease;
    }

    @keyframes copySuccess {
        0% { transform: scale(1); }
        50% { transform: scale(1.15); }
        100% { transform: scale(1); }
    }

    .message-text {
        line-height: 1.6;
        word-wrap: break-word;
        font-size: 0.95rem;
    }

    .message-text h1, .message-text h2, .message-text h3 {
        color: var(--text-color);
        margin: 0.875rem 0 0.5rem 0;
        font-weight: 600;
    }

    .message-text strong {
        color: var(--primary-color);
        font-weight: 600;
    }

    .message-text em {
        color: var(--accent-color);
        font-style: italic;
    }

    .message-text pre {
        background: rgba(67, 97, 238, 0.08);
        padding: 1rem;
        border-radius: 10px;
        overflow-x: auto;
        border-left: 3px solid var(--primary-color);
        margin: 0.875rem 0;
        font-size: 0.9rem;
    }

    .message-text code {
        font-family: 'Courier New', monospace;
        background: rgba(67, 97, 238, 0.08);
        padding: 0.15rem 0.375rem;
        border-radius: 4px;
        color: var(--primary-color);
        font-weight: 500;
        font-size: 0.9em;
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        padding: 3rem;
        color: var(--light-text);
        animation: fadeIn 0.8s ease-out;
    }

    .empty-state.hidden {
        display: none;
    }

    .empty-state i.bi {
        font-size: 3.5rem;
        margin-bottom: 1.25rem;
        color: var(--primary-color);
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.03); opacity: 0.8; }
    }

    .empty-state h4 {
        margin-bottom: 0.875rem;
        color: var(--text-color);
        font-size: 1.6rem;
        font-weight: 700;
    }

    .uploaded-files-preview {
        max-width: 450px;
        width: 100%;
        margin: 1.5rem auto;
        background: rgba(67, 97, 238, 0.06);
        border-radius: 12px;
        padding: 1.25rem;
        border: 1px solid rgba(67, 97, 238, 0.1);
        backdrop-filter: blur(10px);
    }

    .file-preview-item {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        padding: 0.625rem;
        text-align: left;
        border-bottom: 1px solid rgba(67, 97, 238, 0.08);
        transition: all 0.3s ease;
        border-radius: 6px;
    }

    .file-preview-item:hover {
        background: rgba(67, 97, 238, 0.08);
    }

    .file-preview-item:last-child {
        border-bottom: none;
    }

    .file-preview-item i {
        color: var(--primary-color);
        font-size: 1rem;
    }

    .file-preview-more {
        padding: 0.875rem;
        font-size: 0.9rem;
        color: var(--light-text);
        text-align: center;
        font-style: italic;
    }

    .prompt-text {
        margin-top: 1.25rem;
        font-style: italic;
        color: var(--light-text);
        font-size: 1.05rem;
    }

    /* Status Messages */
    .status-message {
        margin-bottom: 0.875rem;
        font-size: 0.95rem;
        min-height: 2em;
        position: relative;
        padding-left: 1.75rem;
        font-weight: 500;
        animation: statusPulse 1.5s ease-in-out infinite;
    }

    @keyframes statusPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.75; }
    }

    .status-message::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 0.875rem;
        height: 0.875rem;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        animation: statusIndicator 1.5s infinite ease-in-out;
    }

    @keyframes statusIndicator {
        0%, 100% {
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }
        50% {
            transform: translateY(-50%) scale(1.15);
            opacity: 0.75;
        }
    }

    .status-message.error::before {
        background: linear-gradient(135deg, var(--error-color), #ff006e);
        animation: errorIndicator 0.75s infinite ease-in-out;
    }

    @keyframes errorIndicator {
        0%, 100% {
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }
        50% {
            transform: translateY(-50%) scale(1.2);
            opacity: 0.6;
        }
    }

    /* References */
    .reference-link {
        cursor: pointer;
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
        padding: 0.15rem 0.375rem;
        border-radius: 4px;
        background: rgba(67, 97, 238, 0.08);
        transition: all 0.3s ease;
        border: 1px solid rgba(67, 97, 238, 0.15);
        font-size: 0.85em;
    }

    .reference-link:hover {
        color: white;
        background: var(--primary-color);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(67, 97, 238, 0.25);
    }

    /* Sources Section */
    .message-sources {
        margin-top: 1.25rem;
        font-size: 0.85rem;
        background: rgba(67, 97, 238, 0.06);
        padding: 1.25rem;
        border-radius: 12px;
        border: 1px solid rgba(67, 97, 238, 0.1);
        backdrop-filter: blur(10px);
    }

    .sources-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.875rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(67, 97, 238, 0.15);
    }

    .sources-title {
        font-weight: 600;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .sources-title::before {
        content: "üìÇ";
        font-size: 1rem;
    }

    .toggle-sources-btn {
        background: rgba(67, 97, 238, 0.08);
        border: 1px solid rgba(67, 97, 238, 0.15);
        color: var(--primary-color);
        cursor: pointer;
        font-size: 0.8rem;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .toggle-sources-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
    }

    .sources-list {
        max-height: 280px;
        overflow-y: auto;
        transition: all 0.3s ease;
    }

    .message-source {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        padding: 0.875rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(67, 97, 238, 0.08);
    }

    .message-source:hover {
        background: rgba(67, 97, 238, 0.1);
        transform: translateX(3px);
        box-shadow: 0 2px 12px rgba(67, 97, 238, 0.15);
        border-color: rgba(67, 97, 238, 0.2);
    }

    .message-source-icon {
        color: var(--primary-color);
        font-size: 1.1rem;
    }

    .message-source span {
        font-weight: 500;
        color: var(--text-color);
    }

    .last-clicked-source {
        background: rgba(67, 97, 238, 0.15) !important;
        border-color: var(--primary-color) !important;
        transform: translateX(3px);
    }

    /* Chat Input Container */
    .chat-input-container {
        position: fixed;
        bottom: 0;
        left: var(--sidebar-width);
        right: 260px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(30px);
        padding: 1.25rem 2rem;
        border-top: 1px solid rgba(67, 97, 238, 0.1);
        box-shadow: 0 -4px 25px rgba(67, 97, 238, 0.1);
        z-index: 999;
        transition: all 0.3s ease;
    }

    .input-group {
        display: flex;
        align-items: flex-end;
        gap: 0.875rem;
        max-width: 100%;
    }

    .chat-input {
        flex: 1;
        border: 1px solid rgba(67, 97, 238, 0.15);
        border-radius: 12px;
        padding: 0.875rem 1.125rem;
        resize: none;
        max-height: 120px;
        min-height: 2.75rem;
        font-family: inherit;
        background: rgba(255, 255, 255, 0.95);
        transition: all 0.3s ease;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .chat-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        background: white;
        transform: translateY(-1px);
    }

    .chat-input::placeholder {
        color: var(--light-text);
        font-style: italic;
    }

    .send-btn {
        height: 2.75rem;
        width: 2.75rem;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 1rem;
        box-shadow: 0 2px 12px rgba(67, 97, 238, 0.25);
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
    }

    .send-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .send-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(67, 97, 238, 0.35);
    }

    .send-btn:hover::before {
        left: 100%;
    }

    .send-btn:disabled {
        background: var(--light-text);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .stop-btn {
        background: linear-gradient(135deg, var(--error-color), #ff006e) !important;
    }

    .stop-btn:hover {
        box-shadow: 0 4px 20px rgba(249, 65, 68, 0.35) !important;
    }

    /* Progress Bar */
    .file-progress-container {
        margin-bottom: 0.875rem;
        padding: 0.875rem;
        background: rgba(67, 97, 238, 0.06);
        border-radius: 10px;
        border: 1px solid rgba(67, 97, 238, 0.1);
    }

    .file-progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.625rem;
        font-size: 0.85rem;
        color: var(--text-color);
        font-weight: 500;
    }

    .file-progress-bar {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: rgba(67, 97, 238, 0.1);
        overflow: hidden;
        position: relative;
    }

    .file-progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        transition: width 0.3s ease;
        border-radius: 4px;
        position: relative;
    }

    .file-progress-bar-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* Copy Toast */
    .copy-toast {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: var(--success-color);
        color: rgb(0, 0, 0);
        padding: 0.875rem 1.25rem;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(76, 201, 240, 0.25);
        z-index: 9999;
        opacity: 0;
        transform: translateY(-15px);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
    }

    .copy-toast.show {
        opacity: 1;
        transform: translateY(0);
    }

    /* Mobile Responsive */
    .mobile-sidebar-toggle {
        display: none;
        position: fixed;
        top: 1rem;
        left: 1rem;
        z-index: 200;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 2.75rem;
        height: 2.75rem;
        cursor: pointer;
        box-shadow: 0 2px 12px rgba(67, 97, 238, 0.25);
        transition: all 0.3s ease;
    }

    .mobile-sidebar-toggle:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(67, 97, 238, 0.35);
    }

    .mobile-sidebar-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 140;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .mobile-sidebar-backdrop.show {
        display: block;
        opacity: 1;
    }

    /* Enhanced Preview Modal */
    .preview-modal {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--glassmorphism-bg);
        backdrop-filter: blur(25px);
        border-top: 1px solid var(--glassmorphism-border);
        box-shadow: 0 -8px 30px rgba(67, 97, 238, 0.12);
        z-index: 1000;
        display: none;
        height: 400px;
        flex-direction: column;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 16px 16px 0 0;
        min-height: 200px;
        max-height: 80vh;
    }

    .preview-modal.minimized {
        height: 60px;
        box-shadow: 0 -4px 15px rgba(67, 97, 238, 0.08);
    }

    .preview-modal.maximized {
        height: 90vh;
        border-radius: 12px;
        margin: 2vh;
        left: 2vh;
        right: 2vh;
        bottom: 2vh;
        top: 2vh;
    }

    .preview-modal-header {
        padding: 1rem 1.5rem;
        background: rgba(67, 97, 238, 0.06);
        border-bottom: 1px solid rgba(67, 97, 238, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 16px 16px 0 0;
        flex-shrink: 0;
        cursor: move;
        user-select: none;
        position: relative;
    }

    .preview-modal.maximized .preview-modal-header {
        border-radius: 12px 12px 0 0;
    }

    .preview-modal.minimized .preview-modal-header {
        border-radius: 16px;
        border-bottom: none;
        cursor: pointer;
    }

    .preview-modal-title {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        min-width: 0;
    }

    .preview-modal-title .preview-icon {
        font-size: 1rem;
        flex-shrink: 0;
    }

    .preview-modal-title .preview-filename {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
    }

    .preview-modal-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-shrink: 0;
    }

    .preview-action-btn {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(67, 97, 238, 0.15);
        border-radius: 6px;
        padding: 0.4rem;
        cursor: pointer;
        color: var(--primary-color);
        font-size: 0.85rem;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        backdrop-filter: blur(10px);
    }

    .preview-action-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(67, 97, 238, 0.25);
    }

    .preview-action-btn.close-btn:hover {
        background: var(--error-color);
        border-color: var(--error-color);
    }

    /* Resize Handle */
    .preview-resize-handle {
        height: 4px;
        cursor: ns-resize;
        background: transparent;
        border-top: 1px solid rgba(67, 97, 238, 0.1);
        position: relative;
        flex-shrink: 0;
        transition: all 0.2s ease;
    }

    .preview-resize-handle:hover {
        background: rgba(67, 97, 238, 0.1);
        height: 6px;
    }

    .preview-resize-handle::before {
        content: "‚ãØ";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--primary-color);
        font-size: 1rem;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .preview-resize-handle:hover::before {
        opacity: 1;
    }

    .preview-modal.minimized .preview-resize-handle {
        display: none;
    }

    .preview-modal.maximized .preview-resize-handle {
        display: none;
    }

    /* Preview Content */
    .preview-content {
        flex: 1;
        overflow-y: auto;
        padding: 0;
        background: white;
        border-radius: 0 0 16px 16px;
        transition: all 0.3s ease;
        min-height: 0;
    }

    .preview-modal.minimized .preview-content {
        display: none;
    }

    .preview-modal.maximized .preview-content {
        border-radius: 0 0 12px 12px;
    }

    .preview-content::-webkit-scrollbar {
        width: 6px;
    }

    .preview-content::-webkit-scrollbar-track {
        background: rgba(67, 97, 238, 0.03);
        border-radius: 3px;
    }

    .preview-content::-webkit-scrollbar-thumb {
        background: rgba(67, 97, 238, 0.2);
        border-radius: 3px;
    }

    .preview-content::-webkit-scrollbar-thumb:hover {
        background: rgba(67, 97, 238, 0.3);
    }

    .preview-content .preview-document {
        padding: 1.5rem;
    }

    .preview-document pre {
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        line-height: 1.6;
        margin: 0;
        color: var(--text-color);
        background: rgba(67, 97, 238, 0.04);
        padding: 1.25rem;
        border-radius: 10px;
        overflow-x: auto;
        border-left: 3px solid var(--primary-color);
    }

    .preview-document mark {
        background: linear-gradient(135deg, #fef08a, #fbbf24);
        padding: 0.1em 0.3em;
        border-radius: 0.2em;
        color: var(--text-color);
        font-weight: 500;
    }

    /* Preview States */
    .preview-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--light-text);
        padding: 2rem;
        text-align: center;
    }

    .preview-placeholder i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        color: var(--primary-color);
        animation: pulse 2s ease-in-out infinite;
    }

    .preview-placeholder p {
        margin: 0;
        font-size: 1rem;
        font-weight: 500;
    }

    .preview-loading, .preview-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: 1rem;
        padding: 2rem;
        text-align: center;
    }

    .loading-spinner {
        width: 2rem;
        height: 2rem;
        border: 3px solid rgba(67, 97, 238, 0.2);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s linear infinite;
    }

    .preview-error {
        color: var(--error-color);
    }

    .preview-error i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }

    .btn-retry {
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        margin-top: 1rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .btn-retry:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
    }

    /* Preview Meta Information */
    .preview-meta {
        padding: 1rem 1.5rem;
        font-size: 0.8rem;
        color: var(--light-text);
        background: rgba(67, 97, 238, 0.03);
        border-top: 1px solid rgba(67, 97, 238, 0.1);
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
        flex-shrink: 0;
    }

    .preview-modal.minimized .preview-meta {
        display: none;
    }

    .preview-meta-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.6rem;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 6px;
        border: 1px solid rgba(67, 97, 238, 0.1);
        backdrop-filter: blur(5px);
    }

    .preview-meta-item i {
        color: var(--primary-color);
        font-size: 0.9rem;
    }

    .preview-meta-item a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
    }

    .preview-meta-item a:hover {
        text-decoration: underline;
    }

    /* Keyboard shortcuts indicator */
    .preview-shortcuts {
        position: absolute;
        top: 0.5rem;
        right: 6rem;
        font-size: 0.7rem;
        color: var(--light-text);
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
    }

    .preview-modal-header:hover .preview-shortcuts {
        opacity: 1;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        :root {
            --sidebar-width: 260px;
        }
        
        .documents-panel {
            width: 240px;
        }
        
        .chat-input-container {
            left: 260px;
            right: 240px;
        }
        
        .chat-messages {
            padding: 1.25rem 1.5rem 140px 1.5rem;
        }

        .preview-modal.maximized {
            margin: 1vh;
            left: 1vh;
            right: 1vh;
            bottom: 1vh;
            top: 1vh;
        }
    }

    @media (max-width: 768px) {
        .mobile-sidebar-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modern-sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            z-index: 150;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .modern-sidebar.mobile-open {
            transform: translateX(0);
        }
        
        .documents-panel {
            display: none;
        }
        
        .main-chat-area {
            width: 100%;
            margin-left: 0;
        }
        
        .chat-input-container {
            left: 0;
            right: 0;
        }
        
        .chat-messages {
            padding: 1rem 1rem 140px 1rem;
        }
        
        .message {
            flex-direction: column;
            gap: 0.875rem;
            padding: 1rem;
            margin-left: 0;
            margin-right: 0;
        }
        
        .message-avatar {
            align-self: flex-start;
            width: 36px;
            height: 36px;
        }
        
        .message-actions {
            position: relative;
            top: 0;
            right: 0;
            opacity: 1;
            margin-top: 0.875rem;
            justify-content: flex-end;
        }
        
        .preview-modal {
            height: 60vh;
        }

        .preview-modal.maximized {
            margin: 0;
            left: 0;
            right: 0;
            bottom: 0;
            top: 0;
            border-radius: 0;
        }

        .preview-modal.minimized {
            height: 50px;
        }

        .preview-modal-header {
            padding: 0.75rem 1rem;
        }

        .preview-modal-title {
            font-size: 0.85rem;
        }

        .preview-action-btn {
            width: 1.75rem;
            height: 1.75rem;
            font-size: 0.75rem;
        }

        .preview-shortcuts {
            display: none;
        }
        
        .chat-input-container {
            padding: 1rem 1.25rem;
        }
        
        .chat-header {
            padding: 1rem 1.25rem;
        }
        
        .sidebar-header {
            padding: 1.25rem;
        }

        .copy-toast {
            top: 1rem;
            right: 1rem;
            left: 1rem;
            text-align: center;
        }
    }

    @media (max-width: 480px) {
        .modern-sidebar {
            width: 100%;
            left: -100%;
        }
        
        .sidebar-header {
            padding: 1rem;
        }
        
        .chat-history {
            padding: 1rem;
        }
        
        .send-btn {
            height: 2.5rem;
            width: 2.5rem;
        }
        
        .chat-input {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            min-height: 2.5rem;
        }
        
        .message {
            padding: 0.875rem;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
        }
        
        .chat-messages {
            padding: 1rem 1rem 140px 1rem;
        }

        .chat-input-container {
            padding: 0.875rem 1rem;
        }

        .preview-modal-actions {
            gap: 0.25rem;
        }

        .preview-action-btn {
            width: 1.5rem;
            height: 1.5rem;
            font-size: 0.7rem;
        }
    }

    /* Animation utilities */
    .spin {
        animation: spin 1s linear infinite;
    }

    .fadeIn {
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Mobile Sidebar Toggle -->
<button class="mobile-sidebar-toggle" onclick="toggleMobileSidebar()">
    <i class="bi bi-list"></i>
</button>

<!-- Mobile Sidebar Backdrop -->
<div class="mobile-sidebar-backdrop" onclick="closeMobileSidebar()"></div>

<!-- Copy Toast Notification -->
<div id="copy-toast" class="copy-toast">
    <i class="bi bi-check-circle"></i>
    <span>Message copied to clipboard!</span>
</div>

<div class="deepseek-container">
    <!-- Modern Sidebar -->
    <div class="modern-sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('index') }}" class="new-chat-btn">
                <i class="bi bi-plus-lg"></i> New Upload
            </a>
        </div>
        
        <div class="chat-history">
            {% for conversation in conversations %}
            <div class="chat-item-container {% if conversation.id == chat_id %}active{% endif %}" data-chat-id="{{ conversation.id }}">
                <a href="{{ url_for('chat', chat_id=conversation.id) }}" class="chat-item">
                    <i class="bi bi-chat-left chat-item-icon"></i>
                    <span class="chat-item-title" id="chat-title-{{ conversation.id }}">{{ conversation.title }}</span>
                    <button class="delete-chat-btn" data-chat-id="{{ conversation.id }}" title="Delete chat">
                        <i class="bi bi-trash"></i>
                    </button>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-chat-area" id="chat-container">
        <div class="chat-header">
            <h3 class="chat-title">
                <i class="bi bi-chat-dots chat-title-icon"></i>
                Chat Session
            </h3>
        </div>
       
        <div class="chat-messages" id="chat-messages">
            {% for message in conversation.messages|default([]) %}
            <div class="message {% if message.role == 'assistant' %}message-assistant{% else %}message-user{% endif %}">
                <div class="message-avatar">
                    {% if message.role == 'user' %}
                    <i class="bi bi-person-fill"></i> 
                    {% else %}
                    <i class="bi bi-robot"></i> 
                    {% endif %}
                </div>
                <div class="message-content">
                    <div class="message-actions">
                        <button class="copy-message-btn" onclick="copyMessageToClipboard(this)" title="Copy message">
                            <i class="bi bi-copy"></i>
                        </button>
                    </div>
                    <div class="message-text">
                        {% if message.role == 'assistant' %} 
                        {{ message.content|process_references|safe }} 
                        {% else %} 
                        {{ message.content|replace('\n', '<br>')|safe }} 
                        {% endif %}
                    </div>
                    {% if message.role == 'assistant' and message.sources %}
                    <div class="message-sources">
                        <div class="sources-header">
                            <span class="sources-title">Sources</span> 
                            {% if message.sources|length > 2 %}
                            <button class="toggle-sources-btn" onclick="toggleSources(this)">
                                Show more
                            </button> 
                            {% endif %}
                        </div>
                        <div class="sources-list" style="{% if message.sources|length > 2 %}display: none;{% endif %}">
                            {% for source in message.sources %}
                            <div class="message-source" data-source="{% if source is string %}{{ source }}{% else %}{{ source.path|default('') }}{% endif %}">
                                <i class="bi bi-file-text message-source-icon"></i>
                                <span>
                                    {% if source is string %}
                                    {{ source.split('/')[-1] }}
                                    {% else %}
                                    {{ source.path.split('/')[-1] if source.path else 'Document' }}
                                    {% endif %}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            <!-- Empty State Placeholder -->
            <div id="empty-state-placeholder" class="empty-state {% if conversation.messages %}hidden{% endif %}">
                <div class="empty-state-content">
                    <i class="bi bi-folder2-open"></i>
                    <h4>Documents Ready</h4>
                    <p>Your files have been uploaded successfully.</p>
                    {% if uploaded_files %}
                    <div class="uploaded-files-preview">
                        {% for file in uploaded_files|slice(3) %}
                        <div class="file-preview-item">
                            <i class="bi bi-file-text"></i>
                            <span>{{ file }}</span>
                        </div>
                        {% endfor %} 
                        {% if uploaded_files|length > 3 %}
                        <div class="file-preview-more">
                            +{{ uploaded_files|length - 3 }} more files
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    <p class="prompt-text">Ask your first question to begin analyzing these documents.</p>
                </div>
            </div>
        </div>

        <!-- Enhanced Preview Modal -->
        <div id="preview-modal" class="preview-modal">
            <div class="preview-modal-header" id="preview-header">
                <h6 class="preview-modal-title">
                    <span class="preview-icon">üëÅÔ∏è</span>
                    <span class="preview-filename" id="preview-title">Document Preview</span>
                </h6>
                <div class="preview-shortcuts">ESC to close ‚Ä¢ Double-click to maximize</div>
                <div class="preview-modal-actions">
                    <button class="preview-action-btn" onclick="minimizePreview()" title="Minimize (Ctrl+M)">
                        <i class="bi bi-dash"></i>
                    </button>
                    <button class="preview-action-btn" onclick="toggleMaximizePreview()" title="Maximize/Restore (Ctrl+‚Üë)" id="maximize-btn">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                    <button class="preview-action-btn close-btn" onclick="closePreview()" title="Close (ESC)">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="preview-resize-handle" id="preview-resize-handle"></div>
            <div id="preview-content" class="preview-content">
                <div class="preview-placeholder">
                    <i class="bi bi-file-earmark-text"></i>
                    <p>Select a reference to view document content</p>
                </div>
            </div>
            <div id="preview-meta" class="preview-meta"></div>
        </div>
    </div>

    <!-- Documents Panel -->
    <div class="documents-panel">
        <div class="documents-header">
            <h4 class="documents-title">
                <i class="bi bi-folder2-open"></i> Files
            </h4>
            <span class="document-count">{{ documents|length }}</span>
        </div>
        <div class="document-list">
            {% for document in documents %}
            <div class="document-item" data-path="{{ document.file_path }}">
                <div class="document-icon">
                    {% if document.file_type == '.pdf' %}
                    <i class="bi bi-file-earmark-pdf"></i>
                    {% elif document.file_type == '.docx' %}
                    <i class="bi bi-file-earmark-word"></i>
                    {% elif document.file_type == '.xlsx' %}
                    <i class="bi bi-file-earmark-excel"></i>
                    {% elif document.file_type == '.pptx' %}
                    <i class="bi bi-file-earmark-ppt"></i>
                    {% elif document.file_type in ['.jpg', '.jpeg', '.png'] %}
                    <i class="bi bi-file-earmark-image"></i>
                    {% else %}
                    <i class="bi bi-file-earmark-text"></i>
                    {% endif %}
                </div>
                <div class="document-name">{{ document.file_path.split('/')[-1] }}</div>
                <div class="document-preview-btn" title="Preview document">
                    <i class="bi bi-eye"></i>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Chat Input Container -->
    <div class="chat-input-container">
        <form id="chat-form" method="POST" class="chat-input-wrapper">
            <div class="input-group">
                <textarea name="question" class="chat-input" placeholder="Ask a question about your documents..." required></textarea>
                <button type="submit" class="send-btn" id="send-button">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Make user ID available to JavaScript
    window.currentUserId = "{{ current_user.id|tojson|safe }}";

    // Global variables
    let currentRequestController = null;
    let isPreviewModalOpen = false;
    let previewModalHeight = 400;
    let isMobileSidebarOpen = false;
    let isPreviewMinimized = false;
    let isPreviewMaximized = false;
    let previewDragState = { isDragging: false, startY: 0, startHeight: 0 };

    // DOM elements
    const previewContent = document.getElementById('preview-content');
    const previewTitle = document.querySelector('.preview-filename');
    const previewMeta = document.getElementById('preview-meta');
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.querySelector('.mobile-sidebar-backdrop');
    const copyToast = document.getElementById('copy-toast');
    const previewModal = document.getElementById('preview-modal');
    const previewResizeHandle = document.getElementById('preview-resize-handle');
    const previewHeader = document.getElementById('preview-header');
    const maximizeBtn = document.getElementById('maximize-btn');

    // Copy to clipboard functionality
    async function copyMessageToClipboard(button) {
        const messageContent = button.closest('.message-content');
        const messageTextElement = messageContent.querySelector('.message-text');
        
        let textToCopy = getPlainTextFromElement(messageTextElement);
        
        try {
            await navigator.clipboard.writeText(textToCopy);
            
            const originalIcon = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i>';
            button.classList.add('copied');
            
            showCopyToast();
            
            setTimeout(() => {
                button.innerHTML = originalIcon;
                button.classList.remove('copied');
            }, 2000);
            
        } catch (err) {
            console.error('Failed to copy: ', err);
            
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showCopyToast();
                
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check"></i>';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                    button.classList.remove('copied');
                }, 2000);
                
            } catch (fallbackErr) {
                console.error('Fallback copy failed: ', fallbackErr);
                showCopyToast('Failed to copy message', true);
            }
            
            document.body.removeChild(textArea);
        }
    }

    function getPlainTextFromElement(element) {
        const clone = element.cloneNode(true);
        
        const refLinks = clone.querySelectorAll('.reference-link');
        refLinks.forEach(link => {
            link.replaceWith(link.textContent);
        });
        
        clone.innerHTML = clone.innerHTML
            .replace(/<br\s*\/?>/gi, '\n')
            .replace(/<\/p>/gi, '\n\n')
            .replace(/<\/div>/gi, '\n')
            .replace(/<\/h[1-6]>/gi, '\n\n')
            .replace(/<li>/gi, '‚Ä¢ ')
            .replace(/<\/li>/gi, '\n')
            .replace(/<strong>(.*?)<\/strong>/gi, '$1')
            .replace(/<em>(.*?)<\/em>/gi, '$1')
            .replace(/<code>(.*?)<\/code>/gi, '$1');
        
        let text = clone.textContent || clone.innerText || '';
        text = text.replace(/\n\s*\n\s*\n/g, '\n\n');
        text = text.trim();
        
        return text;
    }

    function showCopyToast(message = 'Message copied to clipboard!', isError = false) {
        const toast = document.getElementById('copy-toast');
        const icon = toast.querySelector('i');
        const text = toast.querySelector('span');
        
        text.textContent = message;
        
        if (isError) {
            icon.className = 'bi bi-exclamation-triangle';
            toast.style.background = 'var(--error-color)';
        } else {
            icon.className = 'bi bi-check-circle';
            toast.style.background = 'var(--success-color)';
        }
        
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // Mobile sidebar functions
    function toggleMobileSidebar() {
        isMobileSidebarOpen = !isMobileSidebarOpen;
        if (isMobileSidebarOpen) {
            sidebar.classList.add('mobile-open');
            backdrop.classList.add('show');
            document.body.style.overflow = 'hidden';
        } else {
            closeMobileSidebar();
        }
    }

    function closeMobileSidebar() {
        isMobileSidebarOpen = false;
        sidebar.classList.remove('mobile-open');
        backdrop.classList.remove('show');
        document.body.style.overflow = 'auto';
    }

    function getCurrentUserId() {
        return window.currentUserId || '1';
    }

    document.addEventListener('DOMContentLoaded', function() {
        initChatForm();
        initReferenceHandlers();
        initPreviewModal();
        initChatHistory();
        initResponsiveHandlers();
        initDocumentTree();
        scrollToBottom();

        const chatInput = document.querySelector('.chat-input');
        if (chatInput) {
            chatInput.focus();
        }
    });

    function initResponsiveHandlers() {
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768 && isMobileSidebarOpen) {
                closeMobileSidebar();
            }
        });

        document.getElementById('chat-messages').addEventListener('click', function() {
            if (window.innerWidth <= 768 && isMobileSidebarOpen) {
                closeMobileSidebar();
            }
        });
    }

    function initDocumentTree() {
        document.querySelectorAll('.document-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (e.target.closest('.document-preview-btn')) {
                    const path = this.getAttribute('data-path');
                    showFilePreview(path);
                } else {
                    document.querySelectorAll('.document-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    this.classList.add('active');
                }
            });
        });
    }

    function initChatForm() {
        const chatForm = document.getElementById('chat-form');
        if (!chatForm) return;

        const textarea = chatForm.querySelector('textarea');
        const sendButton = document.getElementById('send-button');

        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const question = textarea.value.trim();
            if (!question) return;

            if (isMobileSidebarOpen) {
                closeMobileSidebar();
            }

            const placeholder = document.getElementById('empty-state-placeholder');
            if (placeholder) {
                placeholder.classList.add('hidden');
            }

            sendButton.innerHTML = '<i class="bi bi-stop-circle"></i>';
            sendButton.classList.add('stop-btn');
            sendButton.onclick = stopProcessing;

            textarea.disabled = true;
            sendButton.disabled = false;

            addMessageToUI('user', question);

            const assistantMessageId = addMessageToUI('assistant',
                `<div class="dynamic-status-container">
                    <div class="status-message" id="status-message">üîç Starting processing...</div>
                </div>`
            );

            try {
                const controller = new AbortController();
                currentRequestController = controller;

                const chatId = window.location.pathname.split('/').pop();
                const response = await fetch(`/chat/${chatId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question
                    }),
                    signal: controller.signal
                });

                if (!response.ok) throw new Error(await response.text());

                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                let fullAnswer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');

                    for (let i = 0; i < lines.length - 1; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        try {
                            const data = JSON.parse(line);

                            if (data.status === 'status_update') {
                                if (data.message.startsWith('üìÑ Processing')) {
                                    const progressMatch = data.message.match(/\((\d+)\/(\d+)\)/);
                                    if (progressMatch) {
                                        const current = parseInt(progressMatch[1]);
                                        const total = parseInt(progressMatch[2]);
                                        updateFileProgress(current, total);
                                    }
                                }
                                updateProcessingStatus(data.message, null, data.error);
                            } else if (data.status === 'stream_chunk') {
                                const statusContainer = document.querySelector('.dynamic-status-container');
                                if (statusContainer) {
                                    statusContainer.remove();
                                }
                                fullAnswer += data.content;
                                updateMessageInUI(assistantMessageId, 'assistant', fullAnswer);
                            } else if (data.status === 'stream_end') {
                                updateMessageInUI(
                                    assistantMessageId,
                                    'assistant',
                                    fullAnswer,
                                    data.sources || []
                                );

                                const chatId = window.location.pathname.split('/').pop();
                                const chatTitleElement = document.querySelector(`#chat-title-${chatId}`);
                                if (chatTitleElement && chatTitleElement.textContent.trim() === 'New Query') {
                                    const shortTitle = question.length > 50 ?
                                        question.substring(0, 50) + '...' :
                                        question;
                                    updateChatTitle(chatId, shortTitle);
                                }
                            }
                        } catch (e) {
                            console.error('Error parsing chunk:', e);
                        }
                    }

                    buffer = lines[lines.length - 1];
                }

            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error:', error);
                    updateProcessingStatus(`‚ùå Error: ${error.message}`, 100, true);
                    updateMessageInUI(assistantMessageId, 'assistant',
                        'Error: Failed to process your request. Please try again.');
                }
            } finally {
                resetForm();
            }
        });

        function stopProcessing() {
            if (currentRequestController) {
                currentRequestController.abort();
                currentRequestController = null;
                updateProcessingStatus('üõë Processing stopped by user', 100, true);
                resetForm();
            }
        }

        function resetForm() {
            const sendButton = document.getElementById('send-button');
            const textarea = document.querySelector('.chat-input');

            sendButton.innerHTML = '<i class="bi bi-send"></i>';
            sendButton.classList.remove('stop-btn');
            sendButton.onclick = null;
            sendButton.disabled = false;

            currentRequestController = null;
            textarea.disabled = false;
            textarea.value = '';
            textarea.style.height = 'auto';
            textarea.focus();
        }
    }

    function updateChatTitle(chatId, newTitle) {
        document.querySelectorAll(`#chat-title-${chatId}`).forEach(el => {
            el.textContent = newTitle;
        });

        document.querySelectorAll(`.chat-item-container[data-chat-id="${chatId}"] .chat-item-title`).forEach(el => {
            el.textContent = newTitle;
        });

        fetch(`/update_chat_title/${chatId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: newTitle
                })
            })
            .catch(error => {
                console.error('Error updating chat title:', error);
            });
    }

    function initPreviewModal() {
        if (!previewModal || !previewResizeHandle) return;

        // Initialize resize functionality
        initPreviewResize();
        
        // Initialize drag functionality for maximized mode
        initPreviewDrag();
        
        // Initialize keyboard shortcuts
        initPreviewKeyboardShortcuts();

        // Double-click header to maximize/restore
        previewHeader.addEventListener('dblclick', function(e) {
            if (!isPreviewMinimized) {
                toggleMaximizePreview();
            }
        });

        // Click minimized header to restore
        previewHeader.addEventListener('click', function(e) {
            if (isPreviewMinimized) {
                restorePreview();
            }
        });

        window.togglePreviewModal = function() {
            isPreviewModalOpen = !isPreviewModalOpen;
            updatePreviewModalState();
        };

        window.closePreview = function() {
            isPreviewModalOpen = false;
            isPreviewMinimized = false;
            isPreviewMaximized = false;
            updatePreviewModalState();
        };

        window.minimizePreview = function() {
            if (!isPreviewModalOpen) return;
            isPreviewMinimized = true;
            isPreviewMaximized = false;
            updatePreviewModalState();
        };

        window.restorePreview = function() {
            if (!isPreviewModalOpen) return;
            isPreviewMinimized = false;
            isPreviewMaximized = false;
            updatePreviewModalState();
        };

        window.toggleMaximizePreview = function() {
            if (!isPreviewModalOpen || isPreviewMinimized) return;
            isPreviewMaximized = !isPreviewMaximized;
            updatePreviewModalState();
        };

        function updatePreviewModalState() {
            if (!isPreviewModalOpen) {
                previewModal.style.display = 'none';
                previewModal.classList.remove('minimized', 'maximized');
                return;
            }

            previewModal.style.display = 'flex';

            // Update classes
            previewModal.classList.toggle('minimized', isPreviewMinimized);
            previewModal.classList.toggle('maximized', isPreviewMaximized);

            // Update maximize button icon
            if (maximizeBtn) {
                const icon = maximizeBtn.querySelector('i');
                if (isPreviewMaximized) {
                    icon.className = 'bi bi-arrows-angle-contract';
                    maximizeBtn.title = 'Restore (Ctrl+‚Üì)';
                } else {
                    icon.className = 'bi bi-arrows-fullscreen';
                    maximizeBtn.title = 'Maximize (Ctrl+‚Üë)';
                }
            }

            // Set appropriate height for non-maximized, non-minimized state
            if (!isPreviewMinimized && !isPreviewMaximized) {
                previewModal.style.height = `${previewModalHeight}px`;
            }
        }
    }

    function initPreviewResize() {
        let isResizing = false;

        previewResizeHandle.addEventListener('mousedown', function(e) {
            if (isPreviewMinimized || isPreviewMaximized) return;
            
            isResizing = true;
            previewDragState.startY = e.clientY;
            previewDragState.startHeight = previewModal.offsetHeight;
            
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
            
            previewModal.style.userSelect = 'none';
            document.body.style.cursor = 'ns-resize';
            
            e.preventDefault();
        });

        function handleResize(e) {
            if (!isResizing) return;
            
            const deltaY = previewDragState.startY - e.clientY;
            const newHeight = Math.max(200, Math.min(window.innerHeight * 0.8, previewDragState.startHeight + deltaY));
            
            previewModalHeight = newHeight;
            previewModal.style.height = `${newHeight}px`;
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
            
            previewModal.style.userSelect = '';
            document.body.style.cursor = '';
        }
    }

    function initPreviewDrag() {
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let modalStart = { x: 0, y: 0 };

        previewHeader.addEventListener('mousedown', function(e) {
            if (!isPreviewMaximized || e.target.closest('.preview-modal-actions')) return;
            
            isDragging = true;
            dragStart.x = e.clientX;
            dragStart.y = e.clientY;
            
            const rect = previewModal.getBoundingClientRect();
            modalStart.x = rect.left;
            modalStart.y = rect.top;
            
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', stopDrag);
            
            previewModal.style.userSelect = 'none';
            previewHeader.style.cursor = 'grabbing';
            
            e.preventDefault();
        });

        function handleDrag(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - dragStart.x;
            const deltaY = e.clientY - dragStart.y;
            
            let newX = modalStart.x + deltaX;
            let newY = modalStart.y + deltaY;
            
            // Keep modal within viewport bounds
            const maxX = window.innerWidth - previewModal.offsetWidth;
            const maxY = window.innerHeight - previewModal.offsetHeight;
            
            newX = Math.max(0, Math.min(maxX, newX));
            newY = Math.max(0, Math.min(maxY, newY));
            
            previewModal.style.left = `${newX}px`;
            previewModal.style.top = `${newY}px`;
            previewModal.style.right = 'auto';
            previewModal.style.bottom = 'auto';
        }

        function stopDrag() {
            isDragging = false;
            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', stopDrag);
            
            previewModal.style.userSelect = '';
            previewHeader.style.cursor = 'move';
        }
    }

    function initPreviewKeyboardShortcuts() {
        document.addEventListener('keydown', function(e) {
            if (!isPreviewModalOpen) return;

            // ESC to close
            if (e.key === 'Escape') {
                closePreview();
                e.preventDefault();
            }
            
            // Ctrl+M to minimize
            if (e.ctrlKey && e.key === 'm') {
                if (isPreviewMinimized) {
                    restorePreview();
                } else {
                    minimizePreview();
                }
                e.preventDefault();
            }
            
            // Ctrl+ArrowUp to maximize, Ctrl+ArrowDown to restore
            if (e.ctrlKey && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                if (e.key === 'ArrowUp' && !isPreviewMaximized) {
                    toggleMaximizePreview();
                } else if (e.key === 'ArrowDown' && isPreviewMaximized) {
                    toggleMaximizePreview();
                }
                e.preventDefault();
            }
        });
    }

   async function showFilePreview(filename, page = '', highlight = '') {
    if (!filename || typeof filename !== 'string') {
        handlePreviewError('Invalid filename provided');
        return;
    }

    filename = filename.replace(/\\/g, '/').trim();
    filename = filename.split('#')[0].split('?')[0];
    const shortName = filename.split('/').pop();

    previewContent.innerHTML = `
        <div class="preview-loading">
            <div class="loading-spinner"></div>
            <span>Loading document...</span>
            <div class="loading-file-name">${escapeHtml(shortName)}</div>
        </div>
    `;

    if (!isPreviewModalOpen) {
        togglePreviewModal();
    } else if (isPreviewMinimized) {
        restorePreview();
    }

    try {
        previewTitle.textContent = `Preview: ${shortName}`;

        let url = `/get_file_content?path=${encodeURIComponent(filename)}`;
        if (page) url += `&page=${encodeURIComponent(page)}`;
        if (highlight) url += `&highlight=${encodeURIComponent(highlight)}`;

        let response = await fetch(url);

        // Try alternative path if not OK
        if (!response.ok) {
            const alternativePath = `${getCurrentUserId()}/${filename}`;
            const alternativeUrl = `/get_file_content?path=${encodeURIComponent(alternativePath)}`;
            const altResponse = await fetch(alternativeUrl);

            if (!altResponse.ok) {
                throw new Error('File not found');
            }

            url = alternativeUrl;
            response = altResponse;
        }

        const contentType = response.headers.get('content-type') || '';

        if (contentType.includes('application/json')) {
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            let content = data.content || 'No content available';

            // Highlight if needed
            if (highlight) {
                try {
                    const escapedHighlight = highlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const highlightRegex = new RegExp(`(${escapedHighlight})`, 'gi');
                    content = content.replace(highlightRegex, '<mark>$1</mark>');
                } catch (e) {
                    console.warn('Failed to apply highlight:', e);
                }
            }

            const formattedContent = escapeHtml(content)
                .replace(/\n/g, '<br>')
                .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');

            previewContent.innerHTML = `
                <div class="preview-document">
                    <pre>${formattedContent}</pre>
                </div>
            `;
        } else {
            // For plain text or other types
            const text = await response.text();
            previewContent.innerHTML = `
                <div class="preview-document">
                    <pre>${escapeHtml(text)}</pre>
                </div>
            `;
        }

        updatePreviewMeta(shortName, page, highlight, url);

    } catch (error) {
        console.error('Error loading preview:', error);
        handlePreviewError(`Failed to load ${shortName}: ${error.message}`);
    }
}


    function updatePreviewMeta(filename, page, highlight, url) {
        previewMeta.innerHTML = `
            <div class="preview-meta-item">
                <i class="bi bi-file-earmark"></i>
                <span>${escapeHtml(filename)}</span>
            </div>
            ${page ? `<div class="preview-meta-item">
                <i class="bi bi-file-text"></i>
                <span>Page ${escapeHtml(page)}</span>
            </div>` : ''}
            ${highlight ? `<div class="preview-meta-item">
                <i class="bi bi-search"></i>
                <span>"${escapeHtml(highlight)}"</span>
            </div>` : ''}
            <div class="preview-meta-item">
                <i class="bi bi-download"></i>
                <a href="${url}&download=true" download="${escapeHtml(filename)}">Download</a>
            </div>
            <div class="preview-meta-item">
                <i class="bi bi-info-circle"></i>
                <span>Use ESC to close, Ctrl+M to minimize</span>
            </div>
        `;
    }

    function handlePreviewError(message) {
        previewContent.innerHTML = `
            <div class="preview-error">
                <i class="bi bi-exclamation-triangle"></i>
                <p>${message}</p>
            </div>
        `;
    }

    function initReferenceHandlers() {
        document.addEventListener('click', function(e) {
            const sourceElement = e.target.closest('.message-source');
            if (sourceElement) {
                e.preventDefault();
                e.stopPropagation();

                document.querySelectorAll('.last-clicked-source').forEach(el => {
                    el.classList.remove('last-clicked-source');
                });
                sourceElement.classList.add('last-clicked-source');

                const sourceText = sourceElement.dataset.source ||
                    sourceElement.querySelector('span').textContent;
                showFilePreview(sourceText);
                return;
            }

            const refLink = e.target.closest('.reference-link');
            if (refLink) {
                e.preventDefault();
                e.stopPropagation();

                document.querySelectorAll('.last-clicked-source').forEach(el => {
                    el.classList.remove('last-clicked-source');
                });
                refLink.classList.add('last-clicked-source');

                const filename = refLink.dataset.filename;
                const page = refLink.dataset.page || '';
                const highlight = refLink.dataset.highlight || '';
                showFilePreview(filename, page, highlight);
            }
        });
    }

    function initChatHistory() {
        document.querySelectorAll('.delete-chat-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const chatId = this.getAttribute('data-chat-id');
                const chatItem = this.closest('.chat-item-container');

                if (confirm('Are you sure you want to delete this chat?')) {
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i>';
                    this.disabled = true;

                    fetch(`/delete_chat/${chatId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw err; });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            chatItem.style.opacity = '0';
                            setTimeout(() => chatItem.remove(), 300);
                        } else {
                            throw new Error(data.error || 'Failed to delete chat');
                        }
                    })
                    .catch(error => {
                        console.error('Delete error:', error);
                        alert(error.message || 'Error deleting chat');
                        this.innerHTML = originalHTML;
                        this.disabled = false;
                    });
                }
            });
        });
    }

    function toggleSources(button) {
        const sourcesList = button.closest('.message-sources').querySelector('.sources-list');
        const isHidden = sourcesList.style.display === 'none';

        if (isHidden) {
            sourcesList.style.display = 'block';
            button.textContent = 'Hide';
        } else {
            sourcesList.style.display = 'none';
            button.textContent = 'Show more';
        }
    }

    function addMessageToUI(role, content) {
        const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const chatMessages = document.getElementById('chat-messages');

        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${role}`;
        messageDiv.id = messageId;
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="bi ${role === 'user' ? 'bi-person-fill' : 'bi-robot'}"></i>
            </div>
            <div class="message-content">
                <div class="message-actions">
                    <button class="copy-message-btn" onclick="copyMessageToClipboard(this)" title="Copy message">
                        <i class="bi bi-copy"></i>
                    </button>
                </div>
                <div class="message-text">
                    ${role === 'assistant' ? processContentWithReferences(content) : content.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;

        chatMessages.appendChild(messageDiv);
        scrollToBottom();
        return messageId;
    }

    function updateMessageInUI(messageId, role, content, sources = []) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;

        const processedContent = processContentWithReferences(content);
        let sourcesHTML = '';

        if (sources && sources.length > 0) {
            const showToggle = sources.length > 2;
            sourcesHTML = `
                <div class="message-sources">
                    <div class="sources-header">
                        <span class="sources-title">Sources</span>
                        ${showToggle ? '<button class="toggle-sources-btn" onclick="toggleSources(this)">Show more</button>' : ''}
                    </div>
                    <div class="sources-list" style="${showToggle ? 'display: none;' : ''}">
                        ${sources.map(source => {
                            let sourcePath, displayName;
                            
                            if (typeof source === 'string') {
                                sourcePath = source;
                                displayName = source.split('/').pop().split('\\').pop();
                            } else {
                                sourcePath = source.path || source.filename || '';
                                displayName = source.filename || sourcePath.split('/').pop().split('\\').pop();
                            }
                            
                            return `
                                <div class="message-source" data-source="${escapeHtml(sourcePath)}">
                                    <i class="bi bi-file-text message-source-icon"></i>
                                    <span>${escapeHtml(displayName)}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        messageDiv.querySelector('.message-content').innerHTML = `
            <div class="message-actions">
                <button class="copy-message-btn" onclick="copyMessageToClipboard(this)" title="Copy message">
                    <i class="bi bi-copy"></i>
                </button>
            </div>
            <div class="message-text">
                ${processedContent}
            </div>
            ${sourcesHTML}
        `;

        scrollToBottom();
    }

    function processContentWithReferences(content) {
        let documentCounter = 0;
        const documentMap = new Map();

        let processed = content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            .replace(/^\s*-\s+(.*$)/gm, '<li>$1</li>')
            .replace(/^\s*\d+\.\s+(.*$)/gm, '<li>$1</li>')
            .replace(/\n/g, '<br>');

        processed = processed.replace(
            /\[\^([^\|\]]+)(?:\|\|([^\|\]]+))?(?:\|\|([^\|\]]+))?\]/g,
            function(match, filename, page, highlight) {
                if (!documentMap.has(filename)) {
                    documentCounter++;
                    documentMap.set(filename, documentCounter);
                }

                const docNumber = documentMap.get(filename);
                return `<sup class="reference-link" 
                          data-filename="${escapeHtml(filename)}"
                          data-page="${escapeHtml(page || '')}"
                          data-highlight="${escapeHtml(highlight || '')}">
                        [${docNumber}]</sup>`;
            }
        );

        return processed;
    }

    function updateProcessingStatus(message, progress, isError = false) {
        const statusEl = document.getElementById('status-message');
        if (statusEl) {
            statusEl.textContent = message;
            if (isError) {
                statusEl.style.color = 'var(--error-color)';
                statusEl.classList.add('error');
            } else {
                statusEl.style.color = '';
                statusEl.classList.remove('error');
            }
        }
    }

    function updateFileProgress(processed, total) {
        const percent = Math.floor((processed / total) * 100);

        let progressContainer = document.getElementById('file-progress-container');
        if (!progressContainer) {
            progressContainer = document.createElement('div');
            progressContainer.id = 'file-progress-container';
            progressContainer.className = 'file-progress-container';
            progressContainer.innerHTML = `
                <div class="file-progress-label">
                    <span>Analyzing files for response...</span>
                    <span id="file-progress-percent">0%</span>
                </div>
                <div class="file-progress-bar">
                    <div id="file-progress-bar-fill" class="file-progress-bar-fill" style="width: 0%"></div>
                </div>
            `;

            const statusEl = document.getElementById('status-message');
            if (statusEl && statusEl.parentNode) {
                statusEl.parentNode.insertBefore(progressContainer, statusEl);
            }
        }

        document.getElementById('file-progress-bar-fill').style.width = `${percent}%`;
        document.getElementById('file-progress-percent').textContent = `${percent}%`;

        if (percent === 100) {
            setTimeout(() => {
                progressContainer.style.opacity = '0';
                setTimeout(() => progressContainer.remove(), 300);
            }, 1000);
        }
    }

    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') {
            console.warn('Non-string value passed to escapeHtml:', unsafe);
            return '';
        }
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function scrollToBottom() {
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // Make functions globally available
    window.copyMessageToClipboard = copyMessageToClipboard;
    window.toggleSources = toggleSources;
    window.toggleMobileSidebar = toggleMobileSidebar;
    window.closeMobileSidebar = closeMobileSidebar;
    window.togglePreviewModal = togglePreviewModal;
    window.closePreview = closePreview;
    window.minimizePreview = minimizePreview;
    window.restorePreview = restorePreview;
    window.toggleMaximizePreview = toggleMaximizePreview;
</script>
{% endblock %}