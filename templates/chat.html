{% extends "base.html" %}

{% block content %}
<div class="app-container">
    <div class="sidebar">
        <button class="btn-new-chat" onclick="location.href='{{ url_for('index') }}'">
            <i class="bi bi-plus-lg"></i> New Upload
        </button>
        <div class="chat-history">
            {% for id, chat in chats.items() %}
            <div class="chat-item-wrapper {% if id == chat_id %}active{% endif %}" data-chat-id="{{ id }}">
                <a href="{{ url_for('chat', chat_id=id) }}" class="chat-item">
                    <i class="bi bi-chat-left chat-item-icon"></i>
                    <span class="chat-item-title" id="chat-title-{{ id }}">{{ chat.title }}</span>
                    <button class="btn-delete-chat" data-chat-id="{{ id }}" title="Delete chat">
                        <i class="bi bi-trash"></i>
                    </button>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="chat-container" id="chat-container">
        <div class="chat-messages" id="chat-messages">
            {% for message in conversation.messages %}
            <div class="message {% if message.role == 'assistant' %}message-assistant{% else %}message-user{% endif %}">
                <div class="message-avatar">
                    {% if message.role == 'user' %}
                    <i class="bi bi-person-fill"></i>
                    {% else %}
                    <i class="bi bi-robot"></i>
                    {% endif %}
                </div>
                <div class="message-content">
                    <div class="message-text">
                        {% if message.role == 'assistant' %}
                        {{ message.content|process_references|safe }}
                        {% else %}
                        {{ message.content|replace('\n', '<br>')|safe }}
                        {% endif %}
                    </div>
                    {% if message.role == 'assistant' and message.sources %}
                    <div class="message-sources">
                        <div class="sources-header">
                            <span class="supported-files-title">Sources:</span>
                            {% if message.sources|length > 2 %}
                            <button class="btn-toggle-sources" onclick="toggleSources(this)">
                                Show more
                            </button>
                            {% endif %}
                        </div>
                        <div class="sources-list" style="{% if message.sources|length > 2 %}display: none;{% endif %}">
                            {% for source in message.sources %}
                            <div class="message-source" data-source="{{ source }}">
                                <i class="bi bi-file-text message-source-icon"></i>
                                <span>{{ source }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            <!-- Empty State Placeholder -->
            <div id="empty-state-placeholder" class="empty-state {% if conversation.messages %}hidden{% endif %}">
                <div class="empty-state-content">
                    <i class="bi bi-folder2-open"></i>
                    <h4>Documents Ready</h4>
                    <p>Your files have been uploaded successfully.</p>
                    <div class="uploaded-files-preview">
                        {% for file in uploaded_files|slice(3) %}
                        <div class="file-preview-item">
                            <i class="bi bi-file-text"></i>
                            <span>{{ file }}</span>
                        </div>
                        {% endfor %}
                        {% if uploaded_files|length > 3 %}
                        <div class="file-preview-more">
                            +{{ uploaded_files|length - 3 }} more files
                        </div>
                        {% endif %}
                    </div>
                    <p class="prompt-text">Ask your first question to begin analyzing these documents.</p>
                </div>
            </div>
        </div>

        <!-- Preview Modal Bottom Sheet -->
        <div id="preview-modal" class="preview-modal">
            <div class="preview-modal-header">
                <h6 id="preview-title">Document Preview</h6>
                <div class="preview-actions">
                    <button class="btn-preview-action" onclick="togglePreviewModal()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="preview-resize-handle"></div>
            <div id="preview-content" class="preview-content">
                <div class="preview-placeholder">
                    <i class="bi bi-file-earmark-text"></i>
                    <p>Select a reference to view document content</p>
                </div>
            </div>
            <div id="preview-meta" class="preview-meta"></div>
        </div>

        <div class="chat-input-container">
            <form id="chat-form" method="POST" class="chat-input-wrapper">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="input-group">
                    <textarea name="question" class="chat-input" placeholder="Ask a query..." required></textarea>
                    <button type="submit" class="btn-send" id="send-button">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Global variables
    let currentRequestController = null;
    let isPreviewModalOpen = false;
    let previewModalHeight = 300; // Default height in pixels

    // DOM elements
    const previewContent = document.getElementById('preview-content');
    const previewTitle = document.getElementById('preview-title');
    const previewMeta = document.getElementById('preview-meta');

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize all components
        initChatForm();
        initReferenceHandlers();
        initPreviewModal();
        initChatHistory();
        scrollToBottom();

        // Focus the input field for better UX
        const chatInput = document.querySelector('.chat-input');
        if (chatInput) {
            chatInput.focus();
        }
    });

    function initChatForm() {
        const chatForm = document.getElementById('chat-form');
        if (!chatForm) return;

        const textarea = chatForm.querySelector('textarea');
        const sendButton = document.getElementById('send-button');

        // Auto-resize textarea
        textarea.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
        textarea.style.height = 'auto';

        // Handle Enter key submission
        textarea.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // Form submission handler
        chatForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const question = textarea.value.trim();
            if (!question) return;

            // Hide empty state placeholder
            const placeholder = document.getElementById('empty-state-placeholder');
            if (placeholder) {
                placeholder.classList.add('hidden');
            }

            // Change send button to stop button
            sendButton.innerHTML = '<i class="bi bi-stop-circle"></i>';
            sendButton.classList.add('btn-stop-active');
            sendButton.onclick = stopProcessing;

            // Disable form during processing
            textarea.disabled = true;
            sendButton.disabled = false;

            // Add user message
            const userMessageId = addMessageToUI('user', question);

            // Add dynamic status container for processing updates
            const assistantMessageId = addMessageToUI('assistant',
                `<div class="dynamic-status-container">
                    <div class="status-message" id="status-message">üîç Starting processing...</div>
                </div>`
            );

            try {
                // Create an AbortController for the request
                const controller = new AbortController();
                currentRequestController = controller;

                // Send to server
                const chatId = window.location.pathname.split('/').pop();
                // In the chat form submission handler, update the fetch request:
                const response = await fetch(`/chat/${chatId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                    },
                    body: JSON.stringify({ question: question }),
                    signal: controller.signal
                });

                if (!response.ok) throw new Error(await response.text());

                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';
                let fullAnswer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');

                    // Process all complete lines (leave incomplete line in buffer)
                    for (let i = 0; i < lines.length - 1; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        try {
                            const data = JSON.parse(line);

                            if (data.status === 'status_update') {
                                // Only show progress for file processing messages
                                if (data.message.startsWith('üìÑ Processing')) {
                                    // Extract progress from message if available (e.g., "1/3")
                                    const progressMatch = data.message.match(/\((\d+)\/(\d+)\)/);
                                    if (progressMatch) {
                                        const current = parseInt(progressMatch[1]);
                                        const total = parseInt(progressMatch[2]);
                                        updateFileProgress(current, total);
                                    }
                                }
                                updateProcessingStatus(data.message, null, data.error);
                            }
                            else if (data.status === 'stream_chunk') {
                                // Replace the status container with the actual answer
                                if (document.getElementById('dynamic-status-container')) {
                                    document.getElementById('dynamic-status-container').remove();
                                }
                                fullAnswer += data.content;
                                updateMessageInUI(assistantMessageId, 'assistant', fullAnswer);
                            }
                            else if (data.status === 'stream_end') {
                                // Finalize the message with sources if available
                                updateMessageInUI(
                                    assistantMessageId,
                                    'assistant',
                                    fullAnswer,
                                    data.sources || []
                                );

                                // Update chat title with first question if it's still the default
                                const chatId = window.location.pathname.split('/').pop();
                                const chatTitleElement = document.querySelector(`#chat-title-${chatId}`);
                                if (chatTitleElement && chatTitleElement.textContent.trim() === 'New Query') {
                                    const shortTitle = question.length > 50
                                        ? question.substring(0, 50) + '...'
                                        : question;
                                    updateChatTitle(chatId, shortTitle);
                                }
                            }
                            else if (data.status === 'title_update') {
                                // Update chat title in sidebar
                                const chatItem = document.querySelector(`.chat-item-wrapper[data-chat-id="${data.chat_id}"] .chat-item-title`);
                                if (chatItem) {
                                    chatItem.textContent = data.title;
                                }
                            }
                        } catch (e) {
                            console.error('Error parsing chunk:', e);
                        }
                    }

                    buffer = lines[lines.length - 1]; // Keep incomplete line in buffer
                }

            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error:', error);
                    updateProcessingStatus(`‚ùå Error: ${error.message}`, 100, true);
                    updateMessageInUI(assistantMessageId, 'assistant',
                        'Error: Failed to process your request. Please try again.');
                }
            } finally {
                resetForm();
            }
        });

        function stopProcessing() {
            if (currentRequestController) {
                currentRequestController.abort();
                currentRequestController = null;

                // Update the status message
                updateProcessingStatus('üõë Processing stopped by user', 100, true);

                resetForm();
            }
        }

        function resetForm() {
            const sendButton = document.getElementById('send-button');
            const textarea = document.querySelector('.chat-input');

            // Reset the button to send state
            sendButton.innerHTML = '<i class="bi bi-send"></i>';
            sendButton.classList.remove('btn-stop-active');
            sendButton.onclick = null;
            sendButton.disabled = false;

            // Reset other form elements
            currentRequestController = null;
            textarea.disabled = false;
            textarea.value = '';
            textarea.style.height = 'auto';
            textarea.focus();
            scrollToBottom();
        }
    }


    // After successful message send
    function updateChatTitle(chatId, newTitle) {
        // Update ALL instances of the title in the UI immediately
        document.querySelectorAll(`#chat-title-${chatId}`).forEach(el => {
            el.textContent = newTitle;
        });

        // Also update any other potential instances (like in the chat history)
        document.querySelectorAll(`.chat-item-wrapper[data-chat-id="${chatId}"] .chat-item-title`).forEach(el => {
            el.textContent = newTitle;
        });

        // Update the server asynchronously
        fetch(`/update_chat_title/${chatId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify({ title: newTitle })
        })
            .catch(error => {
                console.error('Error updating chat title:', error);
                // You could revert the UI change here if desired
            });
    }
    function initPreviewModal() {
        const modal = document.getElementById('preview-modal');
        const resizeHandle = document.querySelector('.preview-resize-handle');
        const chatContainer = document.getElementById('chat-container');

        // Toggle modal visibility
        window.togglePreviewModal = function () {
            isPreviewModalOpen = !isPreviewModalOpen;

            if (isPreviewModalOpen) {
                modal.style.display = 'flex';
                modal.style.height = `${previewModalHeight}px`;
                chatContainer.style.paddingBottom = `${previewModalHeight}px`;
                document.body.classList.add('preview-modal-open');
            } else {
                modal.style.display = 'none';
                chatContainer.style.paddingBottom = '0';
                document.body.classList.remove('preview-modal-open');
            }
        };

        // Make modal resizable
        resizeHandle.addEventListener('mousedown', function (e) {
            e.preventDefault();
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
            const newHeight = window.innerHeight - e.clientY;
            if (newHeight > 150 && newHeight < window.innerHeight - 100) {
                previewModalHeight = newHeight;
                modal.style.height = `${newHeight}px`;
                chatContainer.style.paddingBottom = `${newHeight}px`;
            }
        }

        function stopResize() {
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }
    }

    // Global variables for preview
    let lastPreviewRequest = null;
    async function showFilePreview(filename, page = '', highlight = '') {
        // Debug logging
        console.log('Attempting to preview file:', { filename, page, highlight });

        // Validate filename
        if (!filename || typeof filename !== 'string') {
            handlePreviewError('Invalid filename provided');
            return;
        }

        // Clean the filename path
        filename = filename.replace(/\\/g, '/').trim();

        // Remove any anchor tags or query parameters from the filename
        filename = filename.split('#')[0].split('?')[0];

        const shortName = filename.split('/').pop();

        // Show loading state
        previewContent.innerHTML = `
        <div class="preview-loading">
            <div class="loading-spinner"></div>
            <span>Loading document...</span>
            <div class="loading-file-name">${escapeHtml(shortName)}</div>
            <div class="loading-file-path">${escapeHtml(filename)}</div>
        </div>
    `;

        // Show the modal if not already open
        if (!isPreviewModalOpen) {
            togglePreviewModal();
        }

        try {
            // Update title immediately
            previewTitle.textContent = `Preview: ${shortName}`;

            // Encode the filename for URL (encode each path segment separately)
            const encodedPath = filename.split('/').map(encodeURIComponent).join('/');
            let url = `/get_file_content?path=${encodedPath}`;

            if (page) url += `&page=${encodeURIComponent(page)}`;
            if (highlight) url += `&highlight=${encodeURIComponent(highlight)}`;

            console.log('Request URL:', url);

            // First check if file exists
            const checkResponse = await fetch(url, { method: 'HEAD' });
            if (!checkResponse.ok) {
                const errorData = await checkResponse.json().catch(() => null);
                throw new Error(errorData?.error || 'File not found on server');
            }

            // Then get the content
            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(errorData?.error || 'Failed to load file');
            }

            // Check content type
            const contentType = response.headers.get('content-type') || '';
            console.log('Content-Type:', contentType);

            if (contentType.includes('application/pdf')) {
                // Handle PDF response
                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);
                renderPdfPreview(objectUrl, shortName);
            }
            else if (contentType.startsWith('image/')) {
                // Handle image response
                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);
                renderImagePreview(objectUrl, shortName);
            }
            else if (contentType.includes('application/json')) {
                // Handle JSON response
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                let content = data.content || 'No content available';

                // Apply highlighting if specified
                if (highlight) {
                    try {
                        const escapedHighlight = highlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const highlightRegex = new RegExp(`(${escapedHighlight})`, 'gi');
                        content = content.replace(highlightRegex, '<mark>$1</mark>');
                    } catch (e) {
                        console.warn('Failed to apply highlight:', e);
                    }
                }

                // Format the content
                let formattedContent = escapeHtml(content)
                    .replace(/\n/g, '<br>')
                    .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');

                // Check if content is JSON
                if (filename.toLowerCase().endsWith('.json')) {
                    try {
                        const jsonObj = JSON.parse(content);
                        formattedContent = syntaxHighlight(jsonObj);
                    } catch (e) {
                        console.warn('Failed to parse as JSON:', e);
                    }
                }

                previewContent.innerHTML = `
                <div class="preview-document">
                    <pre>${formattedContent}</pre>
                </div>
            `;
            }
            else {
                // Fallback for other content types
                const text = await response.text();
                previewContent.innerHTML = `
                <div class="preview-document">
                    <pre>${escapeHtml(text)}</pre>
                </div>
            `;
            }

            // Update metadata section
            updatePreviewMeta(shortName, page, highlight, url);

        } catch (error) {
            console.error('Error loading preview:', error);

            // More detailed error messages
            let errorMessage = error.message;
            if (error.message.includes('not found')) {
                errorMessage = `File not found: ${shortName}`;

                // Suggest checking the file exists in the extracted files
                errorMessage += `<br><small>Please verify the file exists in the extracted documents.</small>`;
            }

            handlePreviewError(errorMessage);
        }
    }

    // Debug function to list all available files
    async function debugListFiles() {
        try {
            const response = await fetch('/get_file_structure');
            const data = await response.json();
            console.log('Available files:', data);
            return data;
        } catch (error) {
            console.error('Error listing files:', error);
            return null;
        }
    }

    // Debug function to check file existence
    async function debugCheckFile(path) {
        try {
            const encodedPath = encodeURIComponent(path);
            const response = await fetch(`/get_file_content?path=${encodedPath}`, { method: 'HEAD' });
            console.log('File check result:', {
                path,
                exists: response.ok,
                status: response.status
            });
            return response.ok;
        } catch (error) {
            console.error('Error checking file:', error);
            return false;
        }
    }


    // Helper functions for different preview types
    function renderPdfPreview(url, title) {
        previewContent.innerHTML = `
        <div class="pdf-preview-container">
            <iframe 
                src="${url}" 
                class="pdf-preview-frame"
                title="PDF Preview: ${escapeHtml(title)}"
                onload="handleIframeLoad(this)"
                onerror="handleIframeError(this)"
            ></iframe>
        </div>
    `;
    }

    function renderImagePreview(url, altText) {
        previewContent.innerHTML = `
        <div class="image-preview-container">
            <img 
                src="${url}" 
                alt="${escapeHtml(altText)}" 
                class="image-preview"
                onload="handleImageLoad(this)"
                onerror="handleImageError(this)"
            >
            <div class="image-loading" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
        </div>
    `;
    }

    function updatePreviewMeta(filename, page, highlight, url) {
        previewMeta.innerHTML = `
        <div class="preview-meta-item">
            <i class="bi bi-file-earmark"></i>
            <span>${escapeHtml(filename)}</span>
        </div>
        ${page ? `<div class="preview-meta-item">
            <i class="bi bi-file-text"></i>
            <span>Page ${escapeHtml(page)}</span>
        </div>` : ''}
        ${highlight ? `<div class="preview-meta-item">
            <i class="bi bi-search"></i>
            <span>"${escapeHtml(highlight)}"</span>
        </div>` : ''}
        <div class="preview-meta-item">
            <i class="bi bi-download"></i>
            <a href="${url}&download=true" download="${escapeHtml(filename)}">Download</a>
        </div>
    `;
    }

    // Error handling functions
    function handlePreviewError(message) {
        previewContent.innerHTML = `
        <div class="preview-error">
            <i class="bi bi-exclamation-triangle"></i>
            <p>${escapeHtml(message)}</p>
            <button class="btn-retry" onclick="retryPreview()">
                <i class="bi bi-arrow-clockwise"></i> Try Again
            </button>
        </div>
    `;
    }

    function handleIframeLoad(iframe) {
        console.log('Iframe loaded successfully');
    }

    function handleIframeError(iframe) {
        handlePreviewError('Failed to load document preview');
    }

    function handleImageLoad(img) {
        img.parentElement.querySelector('.image-loading').style.display = 'none';
    }

    function handleImageError(img) {
        img.parentElement.querySelector('.image-loading').style.display = 'none';
        handlePreviewError('Failed to load image');
    }

    function retryPreview() {
        // Get the last clicked element to retry
        const lastClicked = document.querySelector('.last-clicked-source');
        if (lastClicked) {
            const source = lastClicked.dataset.source ||
                lastClicked.closest('.message-source')?.dataset.source;
            if (source) {
                showFilePreview(source);
            }
        }
    }

    // Utility functions
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function syntaxHighlight(json) {
        if (typeof json != 'string') {
            json = JSON.stringify(json, null, 2);
        }
        json = escapeHtml(json);
        return json.replace(
            /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
            function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            }
        );
    }

    // Initialize reference handlers
    function initReferenceHandlers() {
        document.addEventListener('click', function (e) {
            // Handle message source clicks
            const sourceElement = e.target.closest('.message-source');
            if (sourceElement) {
                e.preventDefault();
                e.stopPropagation();

                // Mark as last clicked
                document.querySelectorAll('.last-clicked-source').forEach(el => {
                    el.classList.remove('last-clicked-source');
                });
                sourceElement.classList.add('last-clicked-source');

                const sourceText = sourceElement.dataset.source ||
                    sourceElement.querySelector('span').textContent;
                showFilePreview(sourceText);
                return;
            }

            // Handle reference link clicks
            const refLink = e.target.closest('.reference-link');
            if (refLink) {
                e.preventDefault();
                e.stopPropagation();

                // Mark as last clicked
                document.querySelectorAll('.last-clicked-source').forEach(el => {
                    el.classList.remove('last-clicked-source');
                });
                refLink.classList.add('last-clicked-source');

                const filename = refLink.dataset.filename;
                const page = refLink.dataset.page || '';
                const highlight = refLink.dataset.highlight || '';
                showFilePreview(filename, page, highlight);
            }
        });
    }

    function initReferenceHandlers() {
        // Handle clicks on message sources
        document.addEventListener('click', function (e) {
            // Handle message source clicks
            if (e.target.closest('.message-source')) {
                const sourceElement = e.target.closest('.message-source');
                const sourceText = sourceElement.dataset.source || sourceElement.querySelector('span').textContent;
                showFilePreview(sourceText);
                e.preventDefault();
                e.stopPropagation();
            }

            // Handle reference link clicks
            if (e.target.closest('.reference-link')) {
                const refLink = e.target.closest('.reference-link');
                const filename = refLink.dataset.filename;
                const page = refLink.dataset.page || '';
                const highlight = refLink.dataset.highlight || '';
                showFilePreview(filename, page, highlight);
                e.preventDefault();
                e.stopPropagation();
            }
        });
    }

    function initChatHistory() {
        document.querySelectorAll('.btn-delete-chat').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();

                const chatId = this.getAttribute('data-chat-id');
                const chatItem = this.closest('.chat-item-wrapper');

                if (confirm('Are you sure you want to delete this chat?')) {
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i>';
                    this.disabled = true;

                    fetch(`/delete_chat/${chatId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw err; });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                chatItem.style.opacity = '0';
                                setTimeout(() => chatItem.remove(), 300);
                            } else {
                                throw new Error(data.error || 'Failed to delete chat');
                            }
                        })
                        .catch(error => {
                            console.error('Delete error:', error);
                            alert(error.message || 'Error deleting chat');
                            this.innerHTML = originalHTML;
                            this.disabled = false;
                        });
                }
            });
        });
    }

    function toggleSources(button) {
        const sourcesList = button.closest('.message-sources').querySelector('.sources-list');
        const isHidden = sourcesList.style.display === 'none';

        if (isHidden) {
            sourcesList.style.display = 'block';
            button.textContent = 'Hide';
        } else {
            sourcesList.style.display = 'none';
            button.textContent = 'Show more';
        }
    }

    function addMessageToUI(role, content) {
        const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const chatMessages = document.getElementById('chat-messages');

        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${role}`;
        messageDiv.id = messageId;
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="bi ${role === 'user' ? 'bi-person-fill' : 'bi-robot'}"></i>
            </div>
            <div class="message-content">
                <div class="message-text">
                    ${role === 'assistant' ? processContentWithReferences(content) : content.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;

        chatMessages.appendChild(messageDiv);
        scrollToBottom();
        return messageId;
    }

    function updateMessageInUI(messageId, role, content, sources = []) {
        const messageDiv = document.getElementById(messageId);
        if (!messageDiv) return;

        const processedContent = processContentWithReferences(content);
        let sourcesHTML = '';

        if (sources && sources.length > 0) {
            const showToggle = sources.length > 2;
            sourcesHTML = `
                <div class="message-sources">
                    <div class="sources-header">
                        <span class="supported-files-title">Sources:</span>
                        ${showToggle ? '<button class="btn-toggle-sources" onclick="toggleSources(this)">Show more</button>' : ''}
                    </div>
                    <div class="sources-list" style="${showToggle ? 'display: none;' : ''}">
                        ${sources.map(source => `
                            <div class="message-source" data-source="${escapeHtml(source)}">
                                <i class="bi bi-file-text message-source-icon"></i>
                                <span>${escapeHtml(source.split('/').pop().split('\\').pop())}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        messageDiv.querySelector('.message-content').innerHTML = `
            <div class="message-text">
                ${processedContent}
            </div>
            ${sourcesHTML}
        `;

        scrollToBottom();
    }

    function processContentWithReferences(content) {
        let documentCounter = 0;
        const documentMap = new Map();

        let processed = content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            .replace(/^\s*-\s+(.*$)/gm, '<li>$1</li>')
            .replace(/^\s*\d+\.\s+(.*$)/gm, '<li>$1</li>')
            .replace(/\n/g, '<br>');

        processed = processed.replace(
            /\[\^([^\|\]]+)(?:\|\|([^\|\]]+))?(?:\|\|([^\|\]]+))?\]/g,
            function (match, filename, page, highlight) {
                if (!documentMap.has(filename)) {
                    documentCounter++;
                    documentMap.set(filename, documentCounter);
                }

                const docNumber = documentMap.get(filename);
                return `<sup class="reference-link" 
                          data-filename="${escapeHtml(filename)}"
                          data-page="${escapeHtml(page || '')}"
                          data-highlight="${escapeHtml(highlight || '')}">
                        [${docNumber}]</sup>`;
            }
        );

        return processed;
    }

    function updateProcessingStatus(message, progress, isError = false) {
        const statusEl = document.getElementById('status-message');

        if (statusEl) {
            statusEl.textContent = message;
            if (isError) {
                statusEl.style.color = '#dc3545';
                statusEl.classList.add('error');
            } else {
                statusEl.style.color = '';
                statusEl.classList.remove('error');
            }
        }
    }

    function updateFileProgress(processed, total) {
        const percent = Math.floor((processed / total) * 100);

        // Create or update progress container
        let progressContainer = document.getElementById('file-progress-container');
        if (!progressContainer) {
            progressContainer = document.createElement('div');
            progressContainer.id = 'file-progress-container';
            progressContainer.className = 'file-progress-container';
            progressContainer.innerHTML = `
            <div class="file-progress-label">
                <span>Analysing files for response. This may take a while.</span>
                <span id="file-progress-percent">0%</span>
            </div>
            <div class="file-progress-bar">
                <div id="file-progress-bar-fill" class="file-progress-bar-fill" style="width: 0%"></div>
            </div>
        `;

            // Insert before the status message
            const statusEl = document.getElementById('status-message');
            if (statusEl && statusEl.parentNode) {
                statusEl.parentNode.insertBefore(progressContainer, statusEl);
            }
        }

        // Update progress
        document.getElementById('file-progress-bar-fill').style.width = `${percent}%`;
        document.getElementById('file-progress-percent').textContent = `${percent}%`;

        // Remove when complete
        if (percent === 100) {
            setTimeout(() => {
                progressContainer.style.opacity = '0';
                setTimeout(() => progressContainer.remove(), 300);
            }, 1000);
        }
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function scrollToBottom() {
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // Helper function for JSON syntax highlighting
    function syntaxHighlight(json) {
        if (typeof json != 'string') {
            json = JSON.stringify(json, null, 2);
        }
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(
            /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
            function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'key';
                    } else {
                        cls = 'string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            }
        );
    }
</script>

<style>
    /* Message styling */
    .message {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
    }

    .message-user {
        background-color: #f0f7ff;
        border: 1px solid #d0e3ff;
    }

    .message-avatar {
        flex-shrink: 0;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #495057;
    }

    .message-content {
        flex-grow: 1;
        min-width: 0;
    }

    .message-text {
        line-height: 1.6;
        word-wrap: break-word;
    }

    /* Empty state placeholder */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: calc(100% - 100px);
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }

    .empty-state.hidden {
        display: none;
    }

    .empty-state i.bi {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #adb5bd;
    }

    .empty-state h4 {
        margin-bottom: 0.5rem;
        color: #495057;
    }

    .uploaded-files-preview {
        max-width: 400px;
        width: 100%;
        margin: 1rem auto;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }

    .file-preview-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }

    .file-preview-item:last-child {
        border-bottom: none;
    }

    .file-preview-more {
        padding: 0.5rem;
        font-size: 0.9rem;
        color: #6c757d;
    }

    .prompt-text {
        margin-top: 1rem;
        font-style: italic;
        color: #6c757d;
    }

    /* Status message styling */
    .status-message {
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
        min-height: 1.5em;
        position: relative;
        padding-left: 1.5rem;
    }

    .status-message::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 0.8rem;
        height: 0.8rem;
        border-radius: 50%;
        background-color: var(--primary-color);
        animation: pulse 1.5s infinite ease-in-out;
    }

    .status-message.error::before {
        background-color: #dc3545;
        animation: pulse-error 0.75s infinite ease-in-out;
    }

    @keyframes pulse {
        0% {
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }

        50% {
            transform: translateY(-50%) scale(1.2);
            opacity: 0.7;
        }

        100% {
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }
    }

    @keyframes pulse-error {
        0% {
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }

        50% {
            transform: translateY(-50%) scale(1.3);
            opacity: 0.5;
        }

        100% {
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }
    }

    /* Reference styling */
    .reference-link {
        cursor: pointer;
        color: var(--primary-color);
        text-decoration: underline;
    }

    .reference-link:hover {
        color: #0d9488;
    }

    /* Sources section styling */
    .message-sources {
        margin-top: 1rem;
        font-size: 0.875rem;
    }

    .sources-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .supported-files-title {
        font-weight: 500;
    }

    .btn-toggle-sources {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }

    .btn-toggle-sources:hover {
        background-color: rgba(16, 163, 127, 0.1);
    }

    .sources-list {
        max-height: 200px;
        overflow-y: auto;
        transition: max-height 0.3s ease;
    }

    .message-source {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
    }

    .message-source:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .message-source-icon {
        color: #9ca3af;
    }

    /* Preview Modal Styles */
    .preview-modal {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #e5e7eb;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: none;
        height: 300px;
        flex-direction: column;
        transition: height 0.2s ease;
    }

    .preview-modal-open {
        --preview-modal-height: 300px;
    }

    .preview-modal-header {
        padding: 12px 16px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .preview-modal-header h6 {
        margin: 0;
        font-size: 1rem;
        font-weight: 500;
        color: #333;
    }

    .preview-actions {
        display: flex;
        gap: 8px;
    }

    .btn-preview-action {
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-preview-action:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .preview-resize-handle {
        height: 8px;
        cursor: ns-resize;
        background-color: #f9fafb;
        border-top: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
    }

    .preview-resize-handle:hover {
        background-color: #e5e7eb;
    }

    .preview-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0;
        background: white;
    }

    .preview-content .preview-document {
        padding: 16px;
    }

    .preview-document pre {
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        margin: 0;
        color: #333;
        background-color: #f8fafc;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
    }

    .preview-document mark {
        background-color: #fef08a;
        padding: 0 0.2em;
        border-radius: 0.25em;
    }

    .preview-meta {
        padding: 8px 16px;
        font-size: 0.8rem;
        color: #6b7280;
        background: #f9fafb;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .preview-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .preview-meta-item a {
        color: #3b82f6;
        text-decoration: none;
    }

    .preview-meta-item a:hover {
        text-decoration: underline;
    }

    .preview-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #9ca3af;
    }

    .preview-placeholder i {
        font-size: 2rem;
        margin-bottom: 8px;
    }

    .preview-placeholder p {
        margin: 0;
        font-size: 0.9rem;
    }

    .preview-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: 8px;
        color: #6b7280;
    }

    .loading-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s linear infinite;
    }

    .preview-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: 8px;
        color: #dc3545;
    }

    .preview-error i {
        font-size: 2rem;
    }

    /* Adjust chat container when preview is open */
    .chat-container {
        padding-bottom: 0;
        transition: padding-bottom 0.2s ease;
        max-width: 1000px;
        width: 100%;
        margin: 0 auto;
        /* center it */
    }

    /* Chat input */
    .chat-input-container {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 1rem;
        border-top: 1px solid #e5e7eb;
    }

    .input-group {
        display: flex;
        align-items: flex-end;
        gap: 0.5rem;
    }

    .chat-input {
        flex-grow: 1;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.75rem;
        resize: none;
        max-height: 150px;
        min-height: 44px;
        font-family: inherit;
    }

    .chat-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.2);
    }

    .btn-send {
        height: 44px;
        width: 44px;
        border: none;
        border-radius: 8px;
        background-color: var(--primary-color);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-send:hover {
        background-color: #0d9488;
    }

    .btn-send:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
    }

    .btn-stop-active {
        background-color: #f44336 !important;
    }

    .btn-stop-active:hover {
        background-color: #d32f2f !important;
    }

    .spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    /* PDF Preview Styles */
    .pdf-preview-container {
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    .pdf-preview-frame {
        width: 100%;
        height: 100%;
        border: none;
    }

    /* Image Preview Styles */
    .image-preview-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: auto;
    }

    .image-preview {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    /* Syntax highlighting for JSON */
    .preview-document.json .key {
        color: #d946ef;
    }

    .preview-document.json .string {
        color: #65a30d;
    }

    .preview-document.json .number {
        color: #2563eb;
    }

    .preview-document.json .boolean {
        color: #9333ea;
    }

    .preview-document.json .null {
        color: #64748b;
    }


    .last-clicked-source {
        background-color: rgba(16, 163, 127, 0.1);
        border-left: 3px solid var(--primary-color);
    }

    .loading-file-name {
        font-size: 0.8rem;
        margin-top: 0.5rem;
        color: #6b7280;
        font-style: italic;
    }

    .office-preview-container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .office-preview-frame {
        flex-grow: 1;
        border: none;
    }

    .office-preview-footer {
        padding: 0.5rem;
        background: #f8f9fa;
        border-top: 1px solid #e5e7eb;
        text-align: center;
    }

    .btn-retry {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        margin-top: 1rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-retry:hover {
        background-color: #0d9488;
    }

    .btn-retry i {
        animation: spin 1s linear infinite;
    }


    .loading-file-path {
        font-size: 0.7rem;
        margin-top: 0.3rem;
        color: #9ca3af;
        word-break: break-all;
        font-family: monospace;
    }

    .debug-tools {
        position: fixed;
        bottom: 10px;
        right: 10px;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
    }

    .debug-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 5px 10px;
        margin: 2px;
        border-radius: 3px;
        cursor: pointer;
    }

    /* Add this to your CSS section */
    .file-progress-container {
        margin-bottom: 10px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .file-progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        font-size: 0.85rem;
        color: #495057;
    }

    .file-progress-bar {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
        overflow: hidden;
    }

    .file-progress-bar-fill {
        height: 100%;
        background-color: var(--primary-color);
        transition: width 0.3s ease;
    }
</style>
{% endblock %}